<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

    <nav class="navbar navbar-dark bg-dark px-3">
        <a href="dashboard.html" class="navbar-brand">Dashboard</a>
        <button class="btn btn-outline-light" onclick="logout()">Logout</button>
    </nav>

    <div class="container mt-4">
        
        <div class="card shadow p-4">
            <h3 class="mb-3">Daftar Users</h3>

            <button class="btn btn-primary mb-3" onclick="loadUsers()">Refresh</button>
            <div id="alert"></div>

            <table class="table table-bordered table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Full-Name</th>
                        <th>Nick-Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Address</th>
                        <th>Birthday</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="usersTable"></tbody>
            </table>
        </div>

    </div>

    <!-- MODAL VIEW USER -->
    <div class="modal fade" id="viewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Detail User</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div id="modalContent"></div>
                </div>

            </div>
        </div>
    </div>

    <!-- MODAL EDIT USER -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Edit User</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="edit_id">

                        <div class="mb-2">
                            <label>Full Name</label>
                            <input id="edit_full_name" class="form-control">
                        </div>

                        <div class="mb-2">
                            <label>Nickname</label>
                            <input id="edit_nickname" class="form-control">
                        </div>

                        <div class="mb-2">
                            <label>Email</label>
                            <input id="edit_email" class="form-control">
                        </div>

                        <div class="mb-2">
                            <label>Phone</label>
                            <input id="edit_phone" class="form-control">
                        </div>

                        <div class="mb-2">
                            <label>Address</label>
                            <input id="edit_address" class="form-control">
                        </div>

                        <div class="mb-2">
                            <label>Birthday</label>
                            <input type="date" id="edit_birthday" class="form-control">
                        </div>

                        <div class="mb-2">
                            <label>Image URL</label>
                            <input id="edit_image" class="form-control">
                        </div>
                    </form>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-success" onclick="saveEdit()">Save Changes</button>
                </div>

            </div>
        </div>
    </div>

    <script src="navigation.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        requireAuth();

        const BASE_URL = "http://localhost:8000/users";
        let usersList = []; // SIMPAN USER DI MEMORY

        async function loadUsers() {
            try {
                usersList = await apiGet(BASE_URL); // SIMPAN SEMUA USER

                const tbody = document.getElementById("usersTable");
                tbody.innerHTML = "";

                usersList.forEach(u => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${u.id}</td>
                            <td>${u.full_name}</td>
                            <td>${u.nickname}</td>
                            <td>${u.email}</td>
                            <td>${u.phone}</td>
                            <td>${u.address}</td>
                            <td>${u.birthday}</td>
                            <td>
                                <button class="btn btn-info btn-sm" onclick='viewUser(${u.id})'>View</button>
                                <button class="btn btn-warning btn-sm" onclick='openEdit(${u.id})'>Edit</button>
                                <button class="btn btn-danger btn-sm" onclick='deleteUser(${u.id})'>Delete</button>
                            </td>
                        </tr>
                    `;
                });

            } catch (err) {
                showAlert(err.message, "danger");
            }
        }

        // ===== VIEW USER =====
        function viewUser(id) {
            const user = usersList.find(x => x.id === id);

            document.getElementById("modalContent").innerHTML = `
                <div class="row">
                    <div class="col-md-4 text-center">
                        <img src="${user.image || 'https://via.placeholder.com/200'}" 
                             class="img-fluid rounded mb-3" 
                             style="max-height: 200px; object-fit: cover;">
                    </div>

                    <div class="col-md-8">
                        <p><strong>ID:</strong> ${user.id}</p>
                        <p><strong>Full Name:</strong> ${user.full_name}</p>
                        <p><strong>Nickname:</strong> ${user.nickname}</p>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>Phone:</strong> ${user.phone}</p>
                        <p><strong>Address:</strong> ${user.address}</p>
                        <p><strong>Birthday:</strong> ${user.birthday}</p>
                    </div>
                </div>
            `;

            new bootstrap.Modal(document.getElementById("viewModal")).show();
        }

        // ===== OPEN EDIT =====
        function openEdit(id) {
            const user = usersList.find(x => x.id === id);

            document.getElementById("edit_id").value = user.id;
            document.getElementById("edit_full_name").value = user.full_name;
            document.getElementById("edit_nickname").value = user.nickname;
            document.getElementById("edit_email").value = user.email;
            document.getElementById("edit_phone").value = user.phone;
            document.getElementById("edit_address").value = user.address;
            document.getElementById("edit_birthday").value = user.birthday;
            document.getElementById("edit_image").value = user.image;

            new bootstrap.Modal(document.getElementById("editModal")).show();
        }

        // ===== SAVE EDIT =====
        async function saveEdit() {
            const id = document.getElementById("edit_id").value;

            const data = {
                full_name: document.getElementById("edit_full_name").value,
                nickname: document.getElementById("edit_nickname").value,
                email: document.getElementById("edit_email").value,
                phone: document.getElementById("edit_phone").value,
                address: document.getElementById("edit_address").value,
                birthday: document.getElementById("edit_birthday").value,
                image: document.getElementById("edit_image").value,
            };

            try {
                await apiPut(`${BASE_URL}/${id}`, data);

                showAlert("User updated successfully!", "success");
                loadUsers();

                bootstrap.Modal.getInstance(document.getElementById("editModal")).hide();
            } catch (err) {
                showAlert(err.message, "danger");
            }
        }

        // ===== DELETE =====
        async function deleteUser(id) {
            if (!confirm("Yakin mau hapus user ini?")) return;

            try {
                await apiDelete(`${BASE_URL}/${id}`);
                showAlert("User deleted!", "success");
                loadUsers();
            } catch (err) {
                showAlert(err.message, "danger");
            }
        }

        function showAlert(msg, type) {
            document.getElementById("alert").innerHTML = `
                <div class="alert alert-${type} my-2">${msg}</div>
            `;
        }

        loadUsers();
    </script>

</body>
</html>
